import React, { useState, useRef } from 'react';
import { useNavigate } from 'react-router-dom';
import axios from 'axios';
import { toast } from 'react-toastify';
import { 
  UploadCloud, 
  File, 
  Tag, 
  Globe,
  Loader,
  X,
  CheckCircle
} from 'react-icons/fa';
import { useAuth } from '../context/AuthContext';

const VideoUpload = () => {
  const { user } = useAuth();
  const navigate = useNavigate();
  const fileInputRef = useRef(null);
  
  const [uploading, setUploading] = useState(false);
  const [uploadProgress, setUploadProgress] = useState(0);
  const [videoFile, setVideoFile] = useState(null);
  const [previewUrl, setPreviewUrl] = useState('');
  
  const [formData, setFormData] = useState({
    title: '',
    description: '',
    category: 'Education',
    tags: '',
    visibility: 'public',
    isMonetized: 'false'
  });

  const categories = [
    'Education', 'Entertainment', 'Technology', 'Music',
    'Gaming', 'Sports', 'Lifestyle', 'News', 'Comedy',
    'Film & Animation', 'Science & Technology', 'Howto & Style',
    'Travel & Events', 'Autos & Vehicles', 'Pets & Animals',
    'Nonprofits & Activism', 'People & Blogs', 'Other'
  ];

  const handleFileChange = (e) => {
    const file = e.target.files[0];
    if (!file) return;

    // Check file type
    const validTypes = ['video/mp4', 'video/webm', 'video/ogg', 'video/quicktime'];
    if (!validTypes.includes(file.type)) {
      toast.error('Please select a valid video file (MP4, WebM, MOV)');
      return;
    }

    // Check file size (2GB max)
    const maxSize = 2 * 1024 * 1024 * 1024; // 2GB
    if (file.size > maxSize) {
      toast.error('File size must be less than 2GB');
      return;
    }

    setVideoFile(file);
    
    // Generate preview URL
    const url = URL.createObjectURL(file);
    setPreviewUrl(url);
    
    // Auto-fill title from filename
    const title = file.name.replace(/\.[^/.]+$/, ""); // Remove extension
    setFormData(prev => ({ ...prev, title }));
  };

  const handleDragOver = (e) => {
    e.preventDefault();
    e.stopPropagation();
  };

  const handleDrop = (e) => {
    e.preventDefault();
    e.stopPropagation();
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      const file = files[0];
      const event = { target: { files: [file] } };
      handleFileChange(event);
    }
  };

  const removeFile = () => {
    setVideoFile(null);
    setPreviewUrl('');
    if (fileInputRef.current) {
      fileInputRef.current.value = '';
    }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    
    if (!videoFile) {
      toast.error('Please select a video file');
      return;
    }

    if (!formData.title.trim()) {
      toast.error('Please enter a title for your video');
      return;
    }

    const uploadData = new FormData();
    uploadData.append('video', videoFile);
    uploadData.append('title', formData.title.trim());
    uploadData.append('description', formData.description.trim());
    uploadData.append('category', formData.category);
    uploadData.append('tags', formData.tags);
    uploadData.append('visibility', formData.visibility);
    uploadData.append('isMonetized', formData.isMonetized);

    try {
      setUploading(true);
      setUploadProgress(0);

      const response = await axios.post('http://localhost:5000/api/videos/upload', uploadData, {
        headers: {
          'Content-Type': 'multipart/form-data',
        },
        onUploadProgress: (progressEvent) => {
          const percentCompleted = Math.round(
            (progressEvent.loaded * 100) / progressEvent.total
          );
          setUploadProgress(percentCompleted);
        },
      });

      toast.success('Video uploaded successfully! Processing has started.');
      
      // Reset form
      setVideoFile(null);
      setPreviewUrl('');
      setFormData({
        title: '',
        description: '',
        category: 'Education',
        tags: '',
        visibility: 'public',
        isMonetized: 'false'
      });
      
      // Navigate to video page after delay
      setTimeout(() => {
        navigate(`/video/${response.data.video.id}`);
      }, 2000);

    } catch (error) {
      console.error('Upload error:', error);
      const errorMessage = error.response?.data?.error || 
                          error.message || 
                          'Upload failed. Please try again.';
      toast.error(errorMessage);
    } finally {
      setUploading(false);
      setUploadProgress(0);
    }
  };

  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({
      ...prev,
      [name]: value
    }));
  };

  return (
    <div className="video-upload-page">
      <div className="container">
        <div className="upload-header">
          <h1>
            <UploadCloud />
            Upload Video
          </h1>
          <p>Share your content with the world</p>
        </div>

        <div className="upload-container">
          {/* Upload Area */}
          <div className="upload-area-section">
            <div 
              className={`upload-area ${videoFile ? 'has-file' : ''}`}
              onDragOver={handleDragOver}
              onDrop={handleDrop}
              onClick={() => fileInputRef.current?.click()}
            >
              <input
                type="file"
                ref={fileInputRef}
                onChange={handleFileChange}
                accept="video/*"
                hidden
              />
              
              {videoFile ? (
                <div className="file-preview">
                  <div className="preview-header">
                    <div className="file-info">
                      <File size={24} />
                      <div>
                        <h4>{videoFile.name}</h4>
                        <p>{(videoFile.size / (1024 * 1024)).toFixed(2)} MB</p>
                      </div>
                    </div>
                    <button 
                      type="button" 
                      className="remove-file"
                      onClick={(e) => {
                        e.stopPropagation();
                        removeFile();
                      }}
                    >
                      <X size={20} />
                    </button>
                  </div>
                  
                  {previewUrl && (
                    <div className="video-preview">
                      <video 
                        src={previewUrl} 
                        controls 
                        preload="metadata"
                        className="preview-player"
                      />
                    </div>
                  )}
                  
                  {uploading && (
                    <div className="upload-progress">
                      <div className="progress-bar">
                        <div 
                          className="progress-fill"
                          style={{ width: `${uploadProgress}%` }}
                        >
                          {uploadProgress}%
                        </div>
                      </div>
                      <p>Uploading... {uploadProgress}%</p>
                    </div>
                  )}
                </div>
              ) : (
                <div className="upload-prompt">
                  <UploadCloud size={64} />
                  <h3>Select video to upload</h3>
                  <p>or drag and drop video files</p>
                  <div className="file-info">
                    <p>MP4, WebM, MOV up to 2GB</p>
                  </div>
                  <button className="btn btn-secondary">
                    Select File
                  </button>
                </div>
              )}
            </div>
          </div>

          {/* Upload Form */}
          <form onSubmit={handleSubmit} className="upload-form">
            <div className="form-section">
              <h3>Video Details</h3>
              
              <div className="form-group">
                <label htmlFor="title" className="form-label">
                  Title *
                </label>
                <input
                  type="text"
                  id="title"
                  name="title"
                  value={formData.title}
                  onChange={handleInputChange}
                  placeholder="Enter a descriptive title"
                  className="form-control"
                  required
                  maxLength="200"
                />
                <small className="char-count">
                  {formData.title.length}/200 characters
                </small>
              </div>

              <div className="form-group">
                <label htmlFor="description" className="form-label">
                  Description
                </label>
                <textarea
                  id="description"
                  name="description"
                  value={formData.description}
                  onChange={handleInputChange}
                  placeholder="Tell viewers about your video"
                  className="form-control"
                  rows="4"
                  maxLength="5000"
                />
                <small className="char-count">
                  {formData.description.length}/5000 characters
                </small>
              </div>

              <div className="form-row">
                <div className="form-group">
                  <label htmlFor="category" className="form-label">
                    <Tag />
                    Category
                  </label>
                  <select
                    id="category"
                    name="category"
                    value={formData.category}
                    onChange={handleInputChange}
                    className="form-control"
                  >
                    {categories.map(category => (
                      <option key={category} value={category}>
                        {category}
                      </option>
                    ))}
                  </select>
                </div>

                <div className="form-group">
                  <label htmlFor="visibility" className="form-label">
                    <Globe />
                    Visibility
                  </label>
                  <select
                    id="visibility"
                    name="visibility"
                    value={formData.visibility}
                    onChange={handleInputChange}
                    className="form-control"
                  >
                    <option value="public">Public</option>
                    <option value="private">Private</option>
                    <option value="unlisted">Unlisted</option>
                  </select>
                </div>
              </div>

              <div className="form-group">
                <label htmlFor="tags" className="form-label">
                  <Tag />
                  Tags
                </label>
                <input
                  type="text"
                  id="tags"
                  name="tags"
                  value={formData.tags}
                  onChange={handleInputChange}
                  placeholder="education, tutorial, web development (comma separated)"
                  className="form-control"
                />
                <small>Add tags to help viewers find your video</small>
              </div>

              {user?.subscription?.plan !== 'free' && (
                <div className="form-group">
                  <label className="form-label">
                    <input
                      type="checkbox"
                      name="isMonetized"
                      checked={formData.isMonetized === 'true'}
                      onChange={(e) => setFormData(prev => ({
                        ...prev,
                        isMonetized: e.target.checked ? 'true' : 'false'
                      }))}
                      className="monetization-checkbox"
                    />
                    <span>Enable monetization for this video</span>
                  </label>
                </div>
              )}
            </div>

            <div className="form-actions">
              <button
                type="button"
                className="btn btn-secondary"
                onClick={() => navigate('/dashboard')}
                disabled={uploading}
              >
                Cancel
              </button>
              <button
                type="submit"
                className="btn btn-primary"
                disabled={uploading || !videoFile}
              >
                {uploading ? (
                  <>
                    <Loader className="spinner" />
                    Uploading ({uploadProgress}%)
                  </>
                ) : (
                  <>
                    <CheckCircle />
                    Upload Video
                  </>
                )}
              </button>
            </div>
          </form>
        </div>

        {/* Upload Guidelines */}
        <div className="upload-guidelines">
          <h3>Upload Guidelines</h3>
          <div className="guidelines-grid">
            <div className="guideline">
              <div className="guideline-icon">üìπ</div>
              <h4>Video Quality</h4>
              <p>Upload in 720p or higher for best quality</p>
            </div>
            <div className="guideline">
              <div className="guideline-icon">üìù</div>
              <h4>Descriptive Titles</h4>
              <p>Use clear, descriptive titles with keywords</p>
            </div>
            <div className="guideline">
              <div className="guideline-icon">üè∑Ô∏è</div>
              <h4>Tags & Categories</h4>
              <p>Add relevant tags and select proper category</p>
            </div>
            <div className="guideline">
              <div className="guideline-icon">‚öñÔ∏è</div>
              <h4>Copyright</h4>
              <p>Only upload content you own or have rights to</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default VideoUpload;
